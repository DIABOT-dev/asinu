name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        type: choice
        options: [camp, prod]
        default: camp
      image_tag:
        description: "Image tag (defaults to workflow SHA)"
        required: false
      ref:
        description: "Git ref to sync before deploy (optional)"
        required: false
  push:
    tags:
      - 'release/**'
      - 'v*'

concurrency:
  group: deploy-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'prod' }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TARGET_ENV: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'prod' }}
      IMAGE_TAG: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.image_tag || github.sha) || github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.ref != ''
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Resolve deployment target
        id: resolve
        run: |
          set -euo pipefail
          ENV="$TARGET_ENV"
          IMAGE="ghcr.io/${GITHUB_REPOSITORY,,}:${IMAGE_TAG}"

          if [ "$ENV" = "camp" ]; then
            HOST="${{ secrets.CAMP_VPS_HOST }}"; [ -z "$HOST" ] && HOST="${{ secrets.VPS_HOST }}"
            USER="${{ secrets.CAMP_VPS_USER }}"; [ -z "$USER" ] && USER="${{ secrets.VPS_USER }}"
            KEY="${{ secrets.CAMP_VPS_SSH_KEY }}"; [ -z "$KEY" ] && KEY="${{ secrets.VPS_SSH_KEY }}"
            BASE_URL="${{ vars.CAMP_BASE_URL }}"; [ -z "$BASE_URL" ] && BASE_URL="https://camp.diabot.top"
            STACK_DIR="${{ vars.CAMP_STACK_DIR }}"; [ -z "$STACK_DIR" ] && STACK_DIR="/home/ubuntu/diabot_camp"
          else
            HOST="${{ secrets.PROD_VPS_HOST }}"
            USER="${{ secrets.PROD_VPS_USER }}"
            KEY="${{ secrets.PROD_VPS_SSH_KEY }}"
            BASE_URL="${{ vars.PROD_BASE_URL }}"; [ -z "$BASE_URL" ] && BASE_URL="https://app.diabot.top"
            STACK_DIR="${{ vars.PROD_STACK_DIR }}"; [ -z "$STACK_DIR" ] && STACK_DIR="/home/ubuntu/diabot_prod"
          fi

          if [ -z "$HOST" ] || [ -z "$USER" ] || [ -z "$KEY" ]; then
            echo "Missing deploy secrets for env=$ENV" >&2
            exit 1
          fi

          {
            echo "env=$ENV"
            echo "image=$IMAGE"
            echo "base_url=$BASE_URL"
            echo "stack_dir=$STACK_DIR"
            printf 'host=%s\n' "$HOST"
            printf 'user=%s\n' "$USER"
            printf 'key<<EOF\n%s\nEOF\n' "$KEY"
          } >> "$GITHUB_OUTPUT"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.resolve.outputs.host }}
          username: ${{ steps.resolve.outputs.user }}
          key: ${{ steps.resolve.outputs.key }}
          script: |
            set -euo pipefail
            APP_DIR="${{ steps.resolve.outputs.stack_dir }}"
            IMAGE="${{ steps.resolve.outputs.image }}"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            cat > docker-compose.yml <<YML
            services:
              app:
                image: ${IMAGE}
                container_name: asinu-app
                restart: unless-stopped
                ports:
                  - "3000:3000"
                environment:
                  - NODE_ENV=production
            YML

            docker compose pull
            docker compose up -d

            for i in {1..30}; do
              if curl -fsS http://localhost:3000/healthz >/dev/null 2>&1; then exit 0; fi
              sleep 2
            done
            echo "healthz not ready" >&2
            exit 1

      - name: External smoke
        env:
          BASE_URL: ${{ steps.resolve.outputs.base_url }}
        run: |
          set -euo pipefail
          curl -fsS "${BASE_URL}/api/qa/selftest"
          curl -fsS "${BASE_URL}/healthz" || true

      - name: Summary
        run: |
          echo "### Deploy" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ steps.resolve.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "- Image: ${{ steps.resolve.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- Base URL: ${{ steps.resolve.outputs.base_url }}" >> $GITHUB_STEP_SUMMARY
