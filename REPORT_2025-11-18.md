# Daily Plan — 18.11.2025

## Objectives
1. Close out all `tsc --noEmit` blockers that surfaced after widening the project include paths and confirm `npm run lint`, `npm run type-check`, and `npm run build:ci` stay green locally.
2. Deliver Dia Brain bridge wiring (mission, rewards, donate) plus an actionable QA smoke harness so QA can run tests A–F with one command.
3. Hand over staging rollout instructions (native auth migrations, env flags, OTP cleanup timer) since SSH/DB access is restricted, then verify results once logs are provided.

## Schedule & Work Breakdown

| Time | Task |
|------|------|
| **08:30 – 11:30** | Sweep every outstanding TypeScript error (Document.tsx JSX runtime, `buildUserContext`, `ViettelClient`, lucide icons, inline `<style jsx>` usage, OpenAI import). Re-run `npm run lint` and `npm run type-check`. Capture any residual blockers in `lint.log`. |
| **11:30 – 12:30** | Execute `npm run build:ci` with the fixed tree, ensure `/api/healthz` stays green locally, and archive the build log for QA. |
| **12:30 – 13:00** | Draft & commit `ops/BOOTSTRAP_STAGING_NATIVE_AUTH.md` so the infra team can self-serve migrations/env updates/systemd timers. (Done in this change set.) |
| **13:00 – 15:30** | Implement Dia Brain bridge helper usages (`emitBridgeEvent` wrappers for mission/reward/donate) and verify mission/reward flows still behave the same; update ENV docs if new vars appear. |
| **15:30 – 17:00** | Build the modular smoke harness under `scripts/smoke/` (Auth, Mission Lite, Rewards, Donate, Bridge env check, Healthz) and wire `npm run smoke` → `tsx scripts/smoke/index.ts`. Document usage + env requirements (session cookie, SMOKE_ALLOW_WRITES, etc.). |
| **17:00 – 18:00** | Await staging logs from the ops run (migrations/env/systemd). Once provided, review outputs, adjust smoke scripts if necessary, and log the verification status into `QA_SMOKE.md` + this report. |

## Deliverables Checklist
- [ ] `tsc --noEmit` passes without manual edits.
- [ ] `npm run lint`, `npm run type-check`, `npm run build:ci`, and `npm run smoke` executed with logs saved.
- [x] `ops/BOOTSTRAP_STAGING_NATIVE_AUTH.md` committed; staging operator can apply migrations + env + OTP timer without our SSH.
- [x] Dia Brain bridge helper emits for mission/reward/donate and remains non-blocking when env is missing.
- [x] Smoke harness reports PASS/SKIP/FAIL per QA tests A–F and respects `SMOKE_ALLOW_WRITES`.
- [ ] QA receives instructions + staging log review summary before EOD.

### Bridge & Smoke status (18/11)
- **Dia Brain Bridge**: `src/lib/bridge.ts:20-138` exposes `emitMissionDoneEvent`, `emitRewardRedeemedEvent`, `emitDonationEvent`—each short-circuits with `{ skipped: true }` when `BRIDGE_URL`/`BRIDGE_KEY` are absent, so mission/reward/donate flows stay non-blocking. Verified by `tests/mission.bridge.spec.ts` (happy path) and the new `tests/bridge.skip.spec.ts` for the “env missing” scenario.
- **Mission Lite emitter usage**: `src/modules/mission/service.ts:17-137` wraps bridge calls in `.catch` to avoid breaking check-ins; rewards/donate APIs (`src/app/api/rewards/redeem/route.ts`, `src/app/api/donate/route.ts`) now emit `reward_redeem`/`donate` events immediately after DB writes.
- **Smoke harness**: `scripts/smoke/` implements Auth (A), Mission (B), Rewards + Donate (D), Bridge (E), Healthz (F). Results are PASS/SKIP/FAIL with SKIP when flags are off or writes disabled. `SMOKE_ALLOW_WRITES=1` gates POSTs; lack of `ASINU_SMOKE_SESSION` fails fast. Usage documented in README (`README.md:4-34`) and env references in `docs/ENV_VARS.md:1-29`.
- **Command**: `npm run smoke` (tsx) prints the checklist summary; combine with `ASINU_SMOKE_SESSION` and optional `SMOKE_BASE_URL`, `SMOKE_REDEEM_ITEM_ID`, `SMOKE_DONATE_*` to exercise a staging stack end-to-end.
- **Tests executed**: `CI=1 npm test` (includes the new bridge skip suite); `npm run lint`, `npm run type-check`, `NEXT_FORCE_SWC_WASM=1 npm run build:ci` for the tree fixed earlier; smoke harness validated with local `SMOKE_ALLOW_WRITES=0` (Auth & Mission PASS, Rewards SKIP).
- **Docs updated**: README quick-start now includes smoke instructions (`README.md:4-34`), QA playbook links to the automated script (`QA_SMOKE.md:1-4`), and env catalog lists new smoke variables plus `NEXT_FORCE_SWC_WASM` (`docs/ENV_VARS.md:3-29`).

### Staging Log Review (18/11)
| Hạng mục | Trạng thái | Bằng chứng | Khuyến nghị |
|----------|-----------|------------|-------------|
| Native auth migrations | ✅ SUCCESS | `psql -v ON_ERROR_STOP=1 'postgresql://postgres:VeryStrongPassword!@172.19.0.2:5432/diabotdb' -f migrations/118_native_auth.sql` và `117_reward_wallet.sql` chỉ báo `NOTICE: ... already exists`, `COMMIT` sạch → schema đã lên đúng. | Không cần hành động thêm. |
| Env / service reload | ⚠️ WARNING | `docker inspect asinu-app` → `"Status":"unhealthy"`, `FailingStreak=611`, healthcheck exit code 8 dù `docker logs asinu-app` chỉ cho thấy Next.js ready. | Kiểm tra `/api/qa/selftest` và health command (`wget -qO- http://$HOSTNAME:3000/api/qa/selftest`) – có thể fail do DB hostname. Sau khi sửa DB connection, restart container để healthcheck về “healthy”. |
| OTP cleanup timer | ❌ ERROR | `/var/log/asinu/otp_cleanup.log` chứa `sh: 1: tsx: not found` và liên tục `getaddrinfo ENOTFOUND asinu-postgres` (10:00–14:00). | Chạy script bằng Node/tsx trong repo (`npm run otp:cleanup` hoặc build JS) và cấu hình hostname DB hợp lệ (ví dụ `postgres://...@asinu-postgres`). Cài đặt systemd timer lại sau khi xác nhận chạy tay thành công. |
| `/api/healthz` | ❌ ERROR | `curl -i http://localhost:3000/api/healthz` → HTTP 503 + payload `{ "database": { "status":"error","error":"getaddrinfo ENOTFOUND asinu-postgres" } }`. | Đồng bộ `DATABASE_URL`/`DIABOT_DB_URL` bên trong container (dùng IP hoặc tạo DNS entry) để app kết nối được Postgres; rerun healthcheck sau khi sửa. |

### Mobile planning handoff (pending)
- `docs/ASINU_MOBILE_SCREENS.md` và `docs/ASINU_MOBILE_CONTRACTS.md` đã mô tả shell, screen contract P0, API table và action matrix. Đang **tạm dừng** implementation cho tới khi template Expo được bàn giao (kể cả nếu còn lỗi nhỏ – cần danh sách biết trước). Ngày mai khi resume chỉ cần tiếp tục từ tài liệu này.
## Kiểm tra “5 cọc bắt buộc” + Cache (18/11)

| Cọc | Hiện trạng | Ghi chú |
|-----|------------|---------|
| Observability (log/metrics/alert) | ⚠️ Chỉ có log `console` rải rác và healthcheck `/api/healthz` (`src/app/api/healthz/route.ts:1`). Không thấy stack tập trung nào cho log tập trung, metrics (Prometheus/Grafana) hay cảnh báo (PagerDuty, Slack). Cần bổ sung agent shipping log + exporter cho DB/queue/Next. |
| Graceful degradation | ⚠️ Một số chỗ có degrade cơ bản (ví dụ Feature Flag gate tại `config/feature-flags.ts:1`, cache AI in-memory `src/modules/ai/cache.ts:1`, fallback trong `/api/ai/gateway/route.ts:191`). Tuy nhiên chưa thấy cơ chế tách hẳn AI vs non-AI: nếu AI Gateway lỗi vẫn có nguy cơ lan sang dashboard. Cần chiến lược degrade mềm (nút tắt AI, fallback copy cứng, circuit breaker). |
| Feature Flag & Config | ✅ Hệ thống flag trung tâm trong `config/feature-flags.ts:1` với cache 60 giây, các API gọi `featureGate`/`featureGateAll` (`src/lib/middleware/featureGate.ts:1`). Env `NEXT_PUBLIC_*` + server flags đã sẵn—chỉ cần catalog hóa giá trị và UI toggle. |
| Data safety (backup/migration/rollback) | ⚠️ Có script backup thủ công `scripts/backup-asinu-db.sh:1` và thư mục `migrations/` đầy đủ (`migrations/117_reward_wallet.sql`, `118_native_auth.sql`). Nhưng chưa có hướng dẫn rollback/migration automation (no `npm run migrate`, chưa có versioning/rollback doc). Cần thêm playbook restore, seeding kiểm chứng, và test migration trước deploy. |
| Product analytics / telemetry | ⚠️ Tồn tại helper `src/lib/analytics/eventTracker.ts:1` và một số API log event (`src/app/api/ai/meal-tip/route.ts:3`, `src/app/api/profile/personality/route.ts:4`). Tuy nhiên mới bao quát Meal Tip/Preference; chưa gắn vào hành vi chính (Mission, Rewards, Family). Không có pipeline gửi ra PostHog/Mixpanel, nên insight người dùng hạn chế. |
| Cache (cọc 6) | ⚠️ Chỉ có cache trong-memory (Meal Suggest `src/app/api/meal/suggest/route.ts:10`, AI cache `src/modules/ai/cache.ts:1`). Không có Redis hay Postgres cache để chia sẻ giữa instance → restart là mất sạch, không hỗ trợ scale ngang. Cần quyết định Redis hoặc sử dụng Postgres `ai_cache`/`mission_cache` với TTL. |

### Việc phải làm thêm (ưu tiên nền tảng)
1. **Observability stack**: Chốt giải pháp log tập trung (vd. Loki/ELK) + exporter metrics (Next.js, Postgres, Node) + alert route về Slack/PagerDuty.
2. **Graceful Degradation**: Thiết kế circuit breaker riêng cho AI Gateway, fallback UI/response khi AI down, đảm bảo phần non-AI (Mission, Rewards) vẫn chạy.
3. **Feature flag/Config console**: Bổ sung dashboard/CLI quản lý flag để QA/ops bật/tắt nhanh thay vì chỉnh env thủ công.
4. **Data safety tooling**: Viết script `npm run migrate` + `npm run rollback`, playbook backup/restore và test migration trước khi deploy.
5. **Product Analytics**: Kết nối `analytics_events` với kho phân tích (PostHog/Mixpanel/BigQuery) và log thêm Mission, Rewards, Family, Donate để biết hành vi thật.
6. **Cache phân tán**: Tích hợp Redis (hoặc Postgres cache table có TTL) cho AI + Meal + Mission, đồng thời thêm quan sát cache hit rate.
7. **Mobile shell (Expo)**: Import template UI Expo vào `mobile-shell/`/`apps/mobile`, đồng bộ theme Asinu, cấu hình build EAS/Gradle để xuất bản APK/AAB + IPA TestFlight.

## Infra Freeze & Backup Update (18/11 Afternoon)
- Rà lại thông số Viettel S3 (`secrets/viettel.env`) và xác thực bằng `aws --endpoint-url https://s3-north1.viettelidc.com.vn s3 ls s3://diabot-prod`. Kết quả OK, các thư mục `_archive/`, `db-backup/`, `meal_images/` list đầy đủ.
- Chuẩn hoá script `/root/asinu/scripts/backup-asinu-db.sh`:
  - `pg_dump` thông qua `docker compose exec asinu-postgres`, gzip thành `asinu-db-full-YYYY-MM-DD-HHMM.sql.gz`.
  - Tự động upload lên `s3://diabot-prod/db-backup/…` và log kết quả. Đã test tay lúc 10:23 → file xuất hiện trên Viettel S3.
  - Giữ tối đa 7 file gzip mới nhất tại `/backup/`, đồng thời cập nhật `asinu-db-latest.sql.gz`.
- Cron `/etc/cron.d/asinu` được cập nhật: 02:00 chạy script backup mới (có upload), 03:30 prune Docker, 04:00 dọn mọi file `diabot_*.sql*` còn sót. Log được gửi qua syslog tags `asinu-backup`/`asinu-backup-rotate`.
- Ghi lại chính sách freeze trong `/root/FREEZE_POLICY.md`: không build Next.js trên VPS, chỉ chạy container hiện hữu, danh sách thư mục “must-keep”, hướng dẫn backup/retention, cảnh báo dung lượng tối thiểu (>=4 GB free).
- Hiện trạng /backup sau cleanup: chỉ còn `asinu-db-full-2025-11-18-1023.sql.gz` và `asinu-db-latest.sql.gz` (~16 KB). Dung lượng root `/dev/vda1`: 4.3 GB trống (77% sử dụng).
